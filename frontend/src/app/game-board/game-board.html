<div class="container">
  <mat-card class="control-panel">
    <mat-card-header>
      <mat-card-title>
        <mat-icon svgIcon="controller" class="title-icon"></mat-icon>
        Minesweeper
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <form [formGroup]="form" (ngSubmit)="createGame()" class="game-form">

        <!-- Row Picker -->
        <div class="spinner-input">
          <label>Rows</label>

          <div class="controls">
            <button (click)="adjustValue('rows', -1)" type="button" mat-icon-button>
              <mat-icon svgIcon="remove"></mat-icon>
            </button>
            <span class="value-display">{{ form.controls.rows.value }}</span>
            <button (click)="adjustValue('rows', 1)" type="button" mat-icon-button>
              <mat-icon svgIcon="add"></mat-icon>
            </button>
          </div>
        </div>

        <!-- Column Picker -->
        <div class="spinner-input">
          <label>Columns</label>

          <div class="controls">
            <button (click)="adjustValue('columns', -1)" type="button" mat-icon-button>
              <mat-icon svgIcon="remove"></mat-icon>
            </button>
            <span class="value-display">{{ form.controls.columns.value }}</span>
            <button type="button" mat-icon-button (click)="adjustValue('columns', 1)">
              <mat-icon svgIcon="add"></mat-icon>
            </button>
          </div>
        </div>

        <mat-form-field appearance="outline" class="diff-select">
          <mat-label>Difficulty</mat-label>
          <mat-select formControlName="difficulty">
            <mat-option value="MEDIUM">Medium</mat-option>
            <mat-option value="HARD">Hard</mat-option>
          </mat-select>
        </mat-form-field>

        <button mat-flat-button color="primary" type="submit" [disabled]="loading() || form.invalid">
          {{ loading() ? 'Loading...' : 'New Game' }}
        </button>
      </form>

      @if (errorMessage()) {
        <div class="error-msg">{{ errorMessage() }}</div>
      }
    </mat-card-content>
  </mat-card>

  <!-- Stats Bar -->
  @if (gameState(); as game) {
    <mat-card class="game-area">
      <div class="stats-bar">
        <div class="stat-item">
          <mat-icon svgIcon="info"></mat-icon>
          {{ game.status }}
        </div>
        <div class="stat-item">
          <mat-icon svgIcon="lives"></mat-icon>
          {{ game.livesLeft }}
        </div>
        <div class="stat-item">
          <mat-icon svgIcon="bomb"></mat-icon>
          {{ game.mineCount }}
        </div>
        <div class="stat-item">
          <mat-icon svgIcon="flag"></mat-icon>
          {{ game.marksLeft }}
        </div>
      </div>

      <div class="board"
           [style.grid-template-columns]="'repeat(' + game.columns + ', 1fr)'"
           (contextmenu)="$event.preventDefault()"
      >

        @for (row of game.grid; track $index) {
          @for (cell of row; track cell.x + '-' + cell.y) {
            <div class="cell"
                 [ngClass]="getCellClass(cell)"
                 (click)="onLeftClick(cell)"
                 (contextmenu)="onRightClick($event, cell)">

              @if (this.isMarked(cell)) {
                <mat-icon class="cell-icon flag" svgIcon="flag"></mat-icon>
              } @else if (this.isMine(cell)) {
                <mat-icon class="cell-icon mine" svgIcon="mine"></mat-icon>
              } @else if (this.isRevealed(cell)) {
                <span class="adj-count" [attr.data-count]="cell.adjacentMines">
                  {{ cell.adjacentMines }}
                </span>
              }
            </div>
          }
        }
      </div>
    </mat-card>
  }
</div>
